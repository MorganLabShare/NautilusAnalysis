
%{
load('D:\LGNs1\Analysis\sm.mat')
runs = [];
close
h = figure


%}

%{

sm.paths.manPaths = paths;
save('D:\LGNs1\Analysis\sm.mat','sm','-v7.3')


%}
%%

edges = sm.skelEdges;
pos = sm.skelPos;

isShaft = sm.isShaft;
isTarg = sm.isTarg;
isAx = sm.isAx;

isFree = ones(size(isShaft));
isUsed = ~isFree;



%%

allPaths = [];
for i = 1:size(runs,1)
    
    dist1 = getDist(pos,runs(i,1:3));
    node1 = find(dist1 == min(dist1),1);
    
    dist2 = getDist(pos,runs(i,4:6));
    node2 = find(dist2 == min(dist2),1);
    
    
    listNum = 1;
    clear pathList
    pathList{1}(1) = node1;
    nextNode = node1;
    finished = 0;
    openEdge = ones(size(edges,1),1);
    oldNode = [];
    while ~finished
        
        for n = 1:listNum % run all paths
            is1 = (edges(:,1)==nextNode(n)) & openEdge;
            openEdge(is1) = 0;
            hit1 = edges(is1,2);
            is2 = (edges(:,2)==nextNode(n)) & openEdge;
            openEdge(is2) = 0;
            hit2 = edges(is2,1);
            hits = cat(1,hit1,hit2);
            
            for ht = 1:length(hits) % Check all hits
                
                if ht == 1
                    useN = n;
                    nextNode(useN) = hits(ht);
                    pathList{useN} = cat(2,pathList{useN},hits(ht));
                else
                    listNum = listNum+1;
                    useN = listNum;
                    nextNode(listNum) = hits(ht);
                    pathList{listNum} = pathList{n};
                    pathList{listNum} = cat(2,pathList{listNum},hits(ht));
                end
                if hits(ht) == node2;
                    finished = 1;
                    usePath = pathList{useN};
                    break
                end
            end
        end
        if length(oldNode)==length(nextNode)
            if sum(abs(oldNode-nextNode))==0
                break
            end
        end
        oldNode = nextNode;
        
    end
    usePath
    paths{i} = usePath; %% record the final path for the run
    allPaths = cat(2,allPaths,usePath);

end



% %% Show skel
% for r  = length(paths)
%     r
    clf
    scatter3(pos(isShaft & isFree,1),pos(isShaft & isFree,2),pos(isShaft & isFree,3),'b','.')
    hold on
    scatter3(pos(isTarg & isFree,1),pos(isTarg & isFree,2),pos(isTarg & isFree,3),'g','.')
    scatter3(pos(isAx & isFree,1),pos(isAx & isFree,2),pos(isAx & isFree,3),'y','.')
    scatter3(pos(allPaths,1),pos(allPaths,2),pos(allPaths,3),10,'r','o','filled')
    scatter3(pos(paths{r},1),pos(paths{r},2),pos(paths{r},3),100,'m','o','filled')
    hold off
    set(gca,'clipping','off')
    %[xi,yi,zi] = getpts(gca)
    %set(h,'DisplayStyle','datatip','SnapToData','off');
    pause(.01)
% end
 d = datacursormode(h);

%% Get points

pts = zeros(2,3);
datacursormode on
dcm_obj = datacursormode(h);
for i = 1:100
display(sprintf('Click on figure for point'))
waitforbuttonpress;
f = getCursorInfo(dcm_obj)
pt = f.Position;
disp(sprintf('%0.2f  %0.2f  %0.2f',pt(1),pt(2),pt(3)))

end


%%
badRun = [86    44      ]
runs = [382.00  212.40  6.00 403.12  192.96  101.36;...
    143.20  227.60  172.00 181.36  188.16  169.36;...
    286.80  180.00  156.80   299.20  186.00  112.80;...
    455.20  341.40  66.70 452.80  360.00  129.60;...
    462.20  373.40  168.80 447.00  394.10  199.90;...
    447.80  395.30  201.90 447.60  407.60  235.60;...
    452.80  361.20  130.80 462.40  373.20  167.60;...
    136.00  125.20  84.40 165.80  152.60  93.00;...
    196.00  171.20  53.20 168.40  162.72  89.28;...
    181.60  153.60  70.80 183.20  165.60  72.40;...
    233.20  138.80  99.20 210.40  166.00  109.20;...
    210.63  171.14  109.49 229.31  189.31  120.34;...
    192.32  172.96  103.76 173.20  190.80  118.40;...
    164.53  167.87  95.07 191.20  170.00  102.40;...
    215.60  162.80  181.20  212.80  183.30  180.80;...
    231.44  185.76  141.68 214.80  186.24  178.72;...
    181.20  178.67  129.60 228.80  191.60  123.68;...
    216.13  195.20  125.67 204.88  201.84  141.84;...
    204.88  201.84  141.84 184.60  189.00  169.00;...
    171.30  154.90  149.30 153.36  155.20  140.88;...
    163.20  150.67  168.53 144.00  154.40  178.40;...
    362.40  197.60  222.00 389.60  184.40  242.00;...
    392.53  191.87  239.47 384.00  202.80  274.40;...
    392.00  191.47  238.27 391.60  196.00  234.00;...
    411.60  134.56  284.72 425.20  161.20  250.00;...
    426.67  157.87  231.20 423.20  115.60  286.00;...
    425.40  161.20  248.80 436.80  173.00  210.07;...
    434.80  174.80  210.40 390.80  183.60  240.40;...
    414.00  103.20  249.20 468.30  102.20  245.00;...
    511.60  80.00  248.00 481.00  99.67  217.13;...
    509.60  56.00  252.40 501.76  79.52  238.96;...
    486.80  409.20  114.40 508.13  366.47  103.27;...
    508.40  364.80  103.20 507.28  298.24  91.20;...
    454.00  345.60  98.40 457.20  329.07  133.07;...
    341.90  203.60  192.90 387.92  219.12  203.84;...
    458.88  198.88  95.84 460.40  268.60  70.60;...
    461.20  272.40  68.40 455.60  338.00  63.60;...
    520.20  64.40  263.90 511.60  66.00  269.20;...
    512.73  84.40  248.13 527.60  108.00  259.60;...
    523.40  64.60  265.70 536.00  32.56  285.92;...
    522.80  71.20  267.20 500.20  89.40  236.80;...
    487.20  33.20  285.60 472.50  87.90  242.40;...
    472.80  89.20  240.80 478.17  114.46  199.14;...
    478.17  114.46  199.14 478.17  114.46  199.14;...
    412.40  123.52  190.48 470.1  161  157;...
    233.40  192.90  122.00 317.47  186.40  107.20;...
    320.56  186.40  106.48 359.47  191.20  102.80;...
    319.70  186.40  108.70 319.60  186.00  121.20;...
    336.00  174.80  98.80 335.52  185.92  101.84;...
    465.87  179.60  106.67 449.60  209.60  66.00;...
    446.80  369.20  62.40 422.72  345.92  79.04;...
    460.80  226.40  90.80 463.20  230.00  78.00;...
    487.40  158.00  148.60 438.24  173.76  206.24;...
    470.13  164.13  157.47 396.97  222.11  200.74;...
    410.80  122.72  191.60 376.00  75.20  236.40;...
    358.00  81.20  246.00 314.80  37.20  248.80;...
    470.40  404.00  186.40 461.36  378.40  175.52;...
    396.69  222.46  200.97 470.67  163.47  156.93;...
    455.47  176.00  108.80 362.10  191.60  103.10;...
    358.00  81.20  246.00 315.60  38.00  237.20;...
    331.70  17.80  275.70 346.96  42.96  269.44;...
    361.92  35.04  253.68 410.00  122.56  192.40;...
    465.20  110.00  192.80 473.33  122.53  164.33;...
    474.80  126.40  158.40 476.00  116.00  175.60;...
    485.20  161.20  122.40 475.60  129.60  156.40;...
    475.60  129.60  158.27 480.80  100.13  215.87;...
    452.80  176.80  196.00 448.40  174.40  195.60;...
    512.13  79.47  249.07 523.20  64.80  265.20;...
    361.52  80.96  247.60 352.00  46.00  268.00;...
    361.20  80.60  245.80 357.60  83.20  222.40;...
    452.72  364.88  132.16 437.60  360.00  121.60;...
    171.40  157.60  168.20 162.40  147.60  164.40;...
    169.87  158.13  167.33 172.40  154.40  149.60;...
    173.00  154.20  148.60 178.50  159.10  129.10;...
    174.00  154.80  147.60 176.00  158.40  151.20;...
    227.44  184.88  140.40 183.44  186.24  169.60;...
    492.64  237.28  88.16 502.40  290.40  90.40;...
    448.30  367.90  59.50 448.80  381.60  6.00;...
    448.40  365.36  61.52 455.20  341.20  63.60;...
    193.20  171.20  102.80 210.07  170.47  108.87;...
    180.50  174.60  129.30 178.40  160.20  128.80;...
    178.00  164.80  128.80 175.20  157.60  125.60;...
    179.60  156.80  130.40 182.80  151.60  131.20;...
    230.80  185.40  139.80 262.27  190.53  115.47;...
    448.80  403.20  218.00 451.60  405.60  221.60;...
    %451.60  405.60  221.60 380.40  73.60  252.80;...
    376.70  74.70  242.40 375.20  77.20  241.20;...
    370.27  52.53  245.60 373.20  46.40  253.20;...
    508.40  61.10  248.60 509.60  62.40  252.40;...
    449.60  208.80  65.60 440.80  222.00  44.40;...
    439.60  223.20  42.80 431.87  231.33  25.60;...
    431.60  231.60  24.40 426.80  237.60  6.00;...
    443.60  212.80  48.40 439.40  221.40  43.40;...
    430.40  230.40  26.40 423.20  226.80  24.00;...
    427.20  232.40  11.60 427.20  233.60  18.00;...
    456.40  205.60  6.00 481.20  236.00  55.60;...
    481.68  236.48  56.56 492.40  237.28  83.04;...
    496.96  226.16  89.20 506.40  221.60  86.80;...
    383.50  216.10  205.50 383.60  211.60  200.80;...
    508.20  154.80  114.80 497.60  218.40  88.40;...
    485.80  156.50  126.20 486.40  148.80  134.80;...
    372.93  62.27  241.33 372.00  60.00  232.80;...
    363.60  37.20  266.80 362.80  39.20  254.40;...
    474.13  100.80  227.20 472.80  104.80  246.00;...
    520.08  64.72  264.72 517.60  68.40  268.00;...
    450.80  370.40  132.00 453.20  369.60  125.80;...
    508.40  366.40  105.20 503.60  365.20  107.70;...
    360.56  32.80  256.48 352.00  42.96  269.84;...
    363.84  37.68  265.12 346.00  15.20  267.20;...
    444.70  99.90  245.20 446.00  92.80  244.00;...
    360.80  32.24  255.36 355.20  12.80  264.00;...
    361.60  80.80  240.40 358.40  80.80  245.60;...
    346.80  72.72  242.32 343.20  72.40  236.40;...
    180.00  189.20  171.60 181.60  185.60  172.80;...
    179.20  189.20  173.47 179.60  187.20  172.80;...
    203.80  203.00  142.00 198.40  202.00  141.20;...
    188.60  168.80  101.60 184.80  164.80  99.60;...
    208.00  168.40  107.60 205.20  167.60  110.80;...
    472.30  170.90  112.70 472.30  170.90  112.70;...
520.60  143.70  124.30 507.40  151.60  118.80;...
489.68  157.04  145.84 519.50  143.80  129.50;...
472.00  161.73  156.00 486.60  157.30  146.10;...
472.60  170.60  113.00 500.40  154.80  119.20;...
]


runs = [  520.80  143.60  125.87 472.00  171.20  112.40];






 






%  452.80  362.70  134.70 452.80  362.70  134.70];
%
% ;












%set(points(i),'HitTest','on','ButtonDownFcn',{'myFunction',i};


%
% %
%
% s = getCursorInfo(h);
% x=s.Position

% clickedPt = get(gca,'CurrentPoint');
%           VMtx = view(gca);
%           point2d = VMtx * [clickedPt(1,:) 1]';
%           disp(point2d(1:3)')
% set(h, 'WindowButtonDownFcn', {@callbackClickA3DPoint, pos});
%
% d = datacursormode(h);
% for i  = 1:100
% vals = getCursorInfo(d)
% pause(1)
% end
%
%  h = datacursormode;










